<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <title>Rastreamento de Entregas (Kafka)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 24px; }
        .card { border-radius: 14px; }
        .table thead th { font-weight: 600; }
        .muted { color:#6c757d; }
    </style>
</head>
<body>
<h1 class="mb-4">Rastreamento de Entregas [Kafka]</h1>

<!-- feedback pós-envio -->
<div th:if="${param.ok}" class="alert alert-success">Evento enviado com sucesso!</div>
<div th:if="${param.err}" class="alert alert-danger">
  <span th:switch="${param.err}">
    <span th:case="'ETA_invalido'">ETA inválido — informe epoch em milissegundos.</span>
    <span th:case="'Kafka'">Falha ao publicar no Kafka. Verifique o broker/tópico.</span>
    <span th:case="*">Erro ao enviar.</span>
  </span>
</div>

<!-- Formulário -->
<div class="card mb-4">
    <div class="card-body">
        <form method="post" action="/enviar" class="row g-3" onsubmit="return validarForm()" autocomplete="off">
            <div class="col-md-4">
                <label class="form-label" for="entregaId">Entrega ID</label>
                <input name="entregaId" id="entregaId" class="form-control" placeholder="UUID ou texto" required>
                <div class="form-text">
                    <a href="#" onclick="gerarUUID();return false;">Gerar UUID</a>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label" for="status">Status</label>
                <select name="status" id="status" class="form-select" required aria-label="Status" title="Status">
                    <option value="" selected disabled>Selecione...</option>
                    <option th:each="s : ${statusValues}" th:value="${s}" th:text="${s}"></option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label" for="eta">ETA (epoch ms)</label>
                <div class="input-group">
                    <input type="number" step="1" name="estimativaEntregaEpochMs" id="eta"
                           class="form-control" placeholder="ex.: agora + 60000" required>
                    <button class="btn btn-outline-secondary" type="button" onclick="setETA(0)">Agora</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="setETA(60000)">+1 min</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="setETA(300000)">+5 min</button>
                </div>
                <div class="form-text">Sugestão: agora + 60.000 para 1 min no futuro</div>
            </div>

            <div class="col-12">
                <button class="btn btn-primary" type="submit">Enviar evento</button>
            </div>
        </form>
    </div>
</div>

<!-- Listas -->
<div class="row">
    <div class="col-lg-7">
        <h4>Estado atual das entregas</h4>
        <table class="table table-sm table-striped" id="t-status">
            <thead>
            <tr><th>Entrega</th><th>Status</th><th>ETA</th><th>Timestamp</th></tr>
            </thead>
            <tbody>
            <!-- render inicial no servidor -->
            <tr th:if="${#lists.isEmpty(estados)}"><td colspan="4" class="muted">Sem dados ainda.</td></tr>
            <tr th:each="r : ${estados}">
                <td th:text="${r.entregaId}">id</td>
                <td th:text="${r.status}">status</td>
                <td th:text="${r.estimativaEntregaEpochMs}">eta</td>
                <td th:text="${r.timestamp}">ts</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="col-lg-5">
        <h4>Alertas de SLA</h4>
        <ul class="list-group" id="ul-alertas">
            <!-- render inicial no servidor -->
            <li class="list-group-item muted" th:if="${#lists.isEmpty(alertas)}">Sem alertas ainda.</li>
            <li class="list-group-item" th:each="a : ${alertas}">
                <strong th:text="${a.entregaId}">entrega</strong>
                <span class="text-danger">SLA estourado</span>
                <div class="small text-muted">
                    ETA: <span th:text="${a.estimativaEntregaEpochMs}">eta</span> • Detectado:
                    <span th:text="${a.detectadoEmEpochMs}">det</span>
                </div>
                <div th:text="${a.motivo}">motivo</div>
            </li>
        </ul>
    </div>
</div>

<div>
    <button class="btn btn-warning" onclick="fetch('/test/estourar-sla', {method:'POST'})">
        Forçar SLA de teste
    </button>
</div>

<script>
    function nowMs(){ return Date.now(); }
    function setETA(delta){ document.getElementById('eta').value = nowMs() + delta; }
    function gerarUUID(){
        const u = (crypto.randomUUID && crypto.randomUUID()) ||
            'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
                const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
            });
        document.getElementById('entregaId').value = u;
    }
    function validarForm(){
        const s = document.getElementById('status').value;
        const etaStr = document.getElementById('eta').value?.trim();
        const etaNum = Number(etaStr);
        if(!s){ alert('Escolha um status.'); return false; }
        if(!etaStr || Number.isNaN(etaNum)){ alert('ETA inválido — use epoch em ms.'); return false; }
        return true;
    }
    function fmt(x){
        if(!x) return '';
        const n = Number(x);
        try { return new Date(n).toLocaleString(); } catch { return String(x); }
    }

    // Polling leve pra atualizar as tabelas (sem cache)
    async function refresh(){
        try{
            const [st, al] = await Promise.all([
                fetch('/api/status',  {cache: 'no-store'}),
                fetch('/api/alertas', {cache: 'no-store'})
            ]);
            const status = await st.json();
            const alertas = await al.json();

            // tabela status
            const tbody = document.querySelector('#t-status tbody');
            tbody.innerHTML = '';
            if (!status.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="muted">Sem dados ainda.</td>`;
                tbody.appendChild(tr);
            } else {
                status.forEach(r=>{
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.entregaId}</td><td>${r.status}</td>
                          <td title="${r.estimativaEntregaEpochMs}">${fmt(r.estimativaEntregaEpochMs)}</td>
                          <td title="${r.timestamp}">${fmt(r.timestamp)}</td>`;
                    tbody.appendChild(tr);
                });
            }

            // lista alertas
            const ul = document.getElementById('ul-alertas');
            ul.innerHTML = '';
            if (!alertas.length) {
                ul.innerHTML = `<li class="list-group-item muted">Sem alertas ainda.</li>`;
            } else {
                alertas.forEach(a=>{
                    const li = document.createElement('li');
                    li.className='list-group-item';
                    li.innerHTML = `<strong>${a.entregaId}</strong> <span class="text-danger">SLA estourado</span>
                          <div class="small text-muted">ETA: <span title="${a.estimativaEntregaEpochMs}">${fmt(a.estimativaEntregaEpochMs)}</span>
                          • Detectado: <span title="${a.detectadoEmEpochMs}">${fmt(a.detectadoEmEpochMs)}</span></div>
                          <div>${a.motivo || ''}</div>`;
                    ul.appendChild(li);
                });
            }
        } catch(e){
            console.warn('Falha no refresh', e);
        }
    }

    // default: agora + 1 min
    setETA(60000);
    setInterval(refresh, 2000);
    refresh();
</script>
</body>
</html>
